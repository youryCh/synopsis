> **Git** - система контроля версий.

```git init``` - инициализирует репозиторий в текущей директории; создаёт директорию .git, которая содержит всё для контроля версий в рабочей директории

```git --version``` - текущая версия установленного git

`git help` - справка.
  - `-a/--all` - subcommands
  - `<subcommand>` - справка по конкретной команде; открывается в браузере.

`.gitkeep` - пустой файл внутри пустой директории, позволяет сохранять пустые директории (уже не пустые, т.к. внутри будет .gitkeep) при коммите (типа общепринятый хак).

___
## Глобальный/локальный конфиг

```git config --list``` - посмотреть текущий конфиг

```git config --global user.name <name>``` - установить имя пользователя; если не указать name, выведет текущее значение

```git config --global user.email <email>``` - установить/посмотреть email

```git config --global color.ui <auto>``` - установить цветовую схему

`git config --local` - локальные настройки, доступны в каждом конкретном репозитории.

___

```git status``` - статус репозитория  
  - ```-s/--short```

___

> **2 шага добавления новых файлов в репозиторий**:
>   - add - добавление в индекс отслеживания
>   - commit - фиксирование изменений


> Отслеживание изменений с помощью хеш-сумм; алгоритм SHA-1 (40 шестнадцатиричных символов).

> **3 состояние файла в git:**
>   - modified - изменен
>   - staged - индексирован
>   - commited - зафиксирован


> **3 секции git проекта:**
>   - working tree - рабочая копия
>   - staging area - индекс
>   - git directory - по сути сам репозиторий


`git clone <ssh/https link>` - clone remote repo.


`git pull` - получить изменения из remote repo
  - `-s/--strategy` - указать стратегию


`git diff` - покажет изменения (не добавленные в индекс)
  - `--staged` - изменения добавленные в индекс

## Working directory

> **.git** - директория, которая по сути и есть репозиторий.

> **working directory** - это все файлы проекта, кроме /.git, эти файлы извлекаются из /.git в момент клонирования.

> Git сравнивает изменения в working directory с файлами в /.git (т.е. состояние на момент последнего коммита).

## Индекс

> **Индекс** - промежуточная область, хранит изменения файлов на пути от working dir -> remote repo.

> Пустые директории не индексируются.

`git add <file>` - добавить изменения в индекс.
  - `.` - все изменённый файлы
  - `-i` - интерактивный режим, позволяет разбить на куски изменения одного файла и выбрать что добавить в индекс

## Commit

> **commit** - (фиксация) окончательное добавление в репозиторий (git запомнит навсегда и будет отслеживать).  
> Это логически завершённое изменение внутри проекта, должен быть **атомарным** - выполнять одну задачу.

> **Цепочка коммитов** - по сути односвязный список, каждый последующий элемент базируется на предыдущем; последний элемент называется головой списка - HEAD.

`git commit` - создать commit; откроет дефолтный редактор для commit message.
  - `-m 'message'` - создать commit message без редактора
  - `-a` - тоже что git add .

```
// обычное добавление коммита
git commit -m 'message'

// добавит в индекс и создаст коммит для одного файла
git commit <file> -m 'message'

// добавит все изменения (кроме новых файлов) в индекс и создаст коммит
git commit -am 'message'
```

## История изменений

`git log` - список коммитов сортированных по дате
  - `-p` - diff для каждого коммита
  - `--oneline` - сокращённый вариант
  - `--name-status` - другой вариант вывода лога
  - `-- <file>` - коммиты файла
  - `--graph` - в виде графа
  - `--all`

`git shortlog` - сокращённый лог из одних commit message.

`git show <hash>` - развёрнутый лог по одному коммиту, с diff.

**Навигация**:
  - `q` - quit
  - `f, space` - forward
  - `b` - backward
```
//показать коммиты, изменявшие todo.md

git log -p --oneline -- todo.md
```

`git show <hash>` - лог одного коммита с diff; можно указать короткий хеш 7 символов.

> **commit hash** - идентификатор коммита из 40/7 символов.

`git blame <file>` - коммиты одного файла

`git grep <string>` - ищет совпадение со строкой во всех файлах проекта (учитывает .gitignore, не ищет в .git).
  - `-i` - без учёта регистра
  - `<hash>` - если указать хеш, ищет в конкретном коммите

```
// список хешей коммитов где встречается synopsis
git grep synopsis $(git rev-list --all)
```

`git reflog` - лог репозитория со ссылками, которые можно использовать чтобы переключиться на любое состояние.

```
git reflog  // вернёт список коммитов

git checkout HEAD@{3}
или
git checkout c6f9d39

// можно переключиться на состояние любого коммита и создать оттуда новую ветку например
```

## Отмена изменений

> Откат не закоммиченных изменений безвозвратен!

`git clean` - удалить не индексированные изменения из рабочей директории.
  - `-f` - force
  - `-d` - directory
  - `-X` - remove gitignore files
  - `-n` - имитирует удаление, покажет что будет удалено

```
// удалить все не индексированные изменения
git clean -fd

// удалить node_modules
git clean -fdX

// посмотреть что будет удалено
git clean -d -n
```

`git restore <file>` - отмена изменений не индексированного файла.
  - `--staged` - отмена индексации файла
  - `.` - все файлы

## Отмена коммитов

> Git движется только вперёд, часто лучше поправить код в новом коммите.  
> ИЗменения истории коммитов опасно, могут возникнуть проблемы при синхронизации с remote repo.

`git clone` - всегда можно в крайнем случае

`git revert <hash>` - отменяет любой коммит; создаёт новый коммит с изменениями, противоположными отменяемому коммиту.
  - `--no-edit` - не откроет редактор commit message

`git reset` - удалить последний коммит/коммиты (не запушенные); по сути сдвигает указатель HEAD на один/несколько коммитов назад.
  - `--hard` - удалить изменения; без этого флага удалит коммит, но изменения останутся в working dir
  - `--no-commit`

```
// переместит HEAD на указанный коммит
git reset --hard <hash>

// удалить последний коммит; HEAD~ по дефолту == 1
git reset --hard HEAD~

// удалить 2 последних коммита
git reset --hard HEAD~2
```

> **HEAD** - последний сделанный коммит.

`git commit --amend` - добавляет новые застейдженные изменения в последний сделанный коммит; по сути делает git reset и новый коммит с добавленными в индекс изменениями.
  - `--no-edit` - без редактирования commit message

`git checkout .` - отмена всех не индексированных изменений.

## Навигация по истории. Ветки

> **Ветка** - по сути это список коммитов.

`git switch <branch>` - переключиться на ветку; более подходящая команда для этого, чем git checkout.
  - `-c` - создать ветку от текущей и переключиться на неё

`git checkout <branch | hash>` - переключиться на указанную ветку/коммит.
  - `-b` - создаст новую ветку от текущей и переключится на неё
  - `.` - отмена всех локальных изменений (не внесённых в индекс)

```
// создать feature ветку от main
git checkout -b feature main
```

`git branch` - покажет текущую ветку.
  - `-d` - удалить ветку
  - `-m <old_name> <new_name>` - переименовать ветку.

```
// создать ветку feature из текущей
git branch feature

// создать ветку feature из develop
git branch feature develop
```

`git push --delete origin/<branch>` - удалить ветку в удалённом репозитории.

## Gitignore

`.gitignore` - список файлов/директорий, игнорируемых git; создавать в корне проекта.

```
// .gitignore

// игнор файла в любой директории проекта
access.log
node_modules/

// игнор директории в корне
/coverage/

// игнорить все файлы .sqlite3 в /db (но не во вложенных директориях)
/db/*.sqlite3

// игнорить все .txt файлы в /doc и во всех вложенных директориях
doc/**/*.txt
```

`git rm --cached <file>` - [doc](https://www.atlassian.com/ru/git/tutorials/undoing-changes/git-rm) удалить файл из списка отслеживаемых; команда противоположная git add; сам файл останется.


## Stash

> **stash** - хранилище внутри /.git, в которое можно спрятать изменения и восстановить при необходимости; например чтобы изменения не попали в коммит.

`git stash` - [doc](https://www.atlassian.com/ru/git/tutorials/saving-changes/git-stash) прячет все изменённые файлы (индексированные, отслеживаемые но не индексированные; не сохранит: новые файлы, игнорируемые).
  - `-u` - сохранит и неиндексированные новые файлы
  - `--all` - сохранит всё, в т.ч. игнорируемые

`git stash pop` - восстановить из stash

> Stash организован как **стек** (LIFO), каждый `git stash pop` извлекает последний сохранённый stash, удаляя его из списка.

`git stash list` - список всех stash

`git stash clear` - удалить всё в stash

`git stash apply stash@{n}` - восстановит изменения из конкретного стеша (n - в git stash list).

`git stash branch <name>` - создаст ветку и восстановит туда изменения.

`git stash push <file>` - добавить file в существующий стеш.

___

`git remote -v` - список подключённых remote repo.

`git remote add origin <remote_repo_url>` - добавить remote repo.

`git remote set-url origin <url>` - замена remote repo url.

___

`ssh-keygen` - SSH key generator.

___

`git push` - загружает изменения из локального репозитория на удалённый.
  - `-u/--set-upstream` - если локально создана новая ветка, которой нет в удалённом

```
git push -u origin new_branch

// проще нажать Publish branch кнопку в Source control VSC
```

___
## Merge

> **Merge** - слияние/объединение двух веток; git пытается найти общий базовый коммит для двух указателей.

`git merge <branch>` - слияние указанной ветки с той на которой находишься; т.е. это объединение коммитов двух веток (сами ветки остаются).
  - `--squash` - объединить коммиты в один
  - `-s/--strategy` - указать стратегию
  - `--abort` - отмена слияния (например при конфликте)
  - `--no-commit` - не создавать merge commit
  - `--no-ff` - запретить перемотку
  - `--ff-only` - только перемотка, иначе вернёт ошибку

```
// объединить все коммиты в один, перенести все изменения ветки feature на текущую ветку,
// не создавать merge commit
git merge feature --squash --no-commit
```

**2 вида merge:**
- `fast-forward merge` - перемотка; применяется если в мастер-ветке не было изменений после ответвления; не создаёт merge commit; по сути переносит указатель HEAD на последний коммит фича-ветки.
- `true merge` - используется когда в мастер-ветке появились коммиты после ответвления фича-ветки; часто возникают конфликты; создаётся merge commit.

### Merge strategy

> **Стратегия слияния** - это алгоритм поиска общего базового коммита.
> `git merge` автоматически выбирает стратегию слияния если не указана явно.

```
// example
git merge -s recursive
```

- `recursive` - рекурсивная; работает с двумя указателями HEAD; default для merge/pull одной ветки.
- `resolve` - решение; стратегия для двух веток; использует алгоритм трёхстороннего слияния; безопасная, быстрая.
- `octopus` - осьминог; применяется по дефолту если более двух HEAD; если в merge передать более одной ветки, octopus включится автоматически; если появляются конфликты, которые не решаются автоматически, то octopus реджектит слияние.
- `ours` - наши; позволяет работать с множеством веток; игнорирует все изменения чужих веток; назначение - объединение истории аналогичных веток.
- `subtree` - поддерево; разновидность рекурсивной стратегии.

___

## Rebase

> [**rebase**](https://www.atlassian.com/ru/git/tutorials/rewriting-history/git-rebase) - перемещение последовательности коммитов (ветки) на новый базовый коммит; по сути это замена базового коммита в основании ветки на новый; полезно если мастер-ветка ушла вперёд после ответвления фича-ветки.  
> Позволяет добиться линейной истории проекта.

`git rebase <base>` - переместить текущую ветку на последний коммит ветки base; по сути как cherry-pick, но для последовательности коммитов (т.е. ветки).
  - `-i` - интерактивный режим
  - `--continue` - продолжение перебазирования после резолва конфликта
  - `--abort` - отмена rebase
  - `--onto <new_base> <old_base>` - позволяет изменить base-ветку

```
// before
   o---o---o---o---o  main
        \
         o---o---o---o---o  featureA
              \
               o---o---o  featureB

git rebase --onto main featureA featureB

                      o---o---o  featureB
                     /
    o---o---o---o---o  main
     \
      o---o---o---o---o  featureA
```

___
## Tag

`git tag <tag>` - присвоить тег.

`git tag` - посмотреть тег.

`git tag --list` - список всех тегов.

`git push --tags` - запушить теги.

`git tag -d <tag>` - удалить тег.

`git push -d origin <tag>` - delete tag on remote repo.

___

## Cherry-pick

`git cherry-pick <hash>` - перенести один конкретный коммит на текущую ветку; по сути как rebase, но для одного коммита.

___

`gitk` - графический просмотр истории.
  - `--all` - все коммиты

`git-gui` - графический инструмент для редактирования коммитов.

___

## Fetch VS pull

`git fetch` - забирает все новые коммиты с удалённого репозитория, но не мержит их.

`git pull` - подтягивает все изменения удалённого репозитория и мержит их текущую ветку;  
по сути pull - это шорткат для fetch + merge.

___

## Git version update

`git -v` - current version.

`git update-git-for-windows` - проверит текущую версию, покажет доступную.

___

