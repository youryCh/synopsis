## Production & deploy

> **Deploy** - процесс выкладывания/разворачивания кода на сервер и запуск.

> **IAC** - infrastructure as code; подход для управления/описания инфраструктуры через конфиг файлы.

> **PAAS** - platform as a service; облачная сервисная платформа; скрывает инфраструктуру; позволяет  
> быстро выкатывать приложение.

> **Production** - среда запуска (сервер/несколько серверов).

> **Release** - обычно это тег в git, который фиксирует что идёт в деплой на продакшн (изменения в мастер ветке  
> после создания тега не повлияют на тег).

**Шаги деплоя:**  
1. доставка кода на сервер (через git, docker, apt)
2. обновление db
3. запуск и остановка

> **Downtime** - простой в работе сервера.

___

## Continues  Integration

> **CI** - непрерывная интеграция; практика разработки с частой авто сборкой приложения, для быстрого выявления  
> проблем.

> CI обычно реализован на отдельном сервере.

**Этапы:**  
- загрузка кода (после PR)  
- сборка  
- проверки (линтер, тесты, утилиты)

> Каждый коммит запускает сборку (установка зависимостей, тесты и пр.).

**Системы CI:**
- GitLab CI  
- GitHub Actions  
- Jenkins

___

## Canary release

> Когда релизится новая версия, переключаем только небольшую часть пользовательского трафика (через балансировщик).  
> Если всё ок, то переключаем всех пользователей на новую версию.  
> Если не ок, то пострадает только небольшая часть пользователей.

**Требуется:**
- балансировка
- мониторинг
- пайплайн (автоматизация)
- анализатор версий

**Метрики** которые обычно мониторятся:
- counter - количество ошибок/успешных ответов
- gauge - время выполнения запроса (latency), размер очереди
- summary - время выполнения 95% запросов

**Инструменты:**
- ELK stack
- Prometheus

___

## Blue-Green Deployment

> Техника бесшовного zero-downtime обновления.

___

## Proxy

Работа веб-приложения
```
           http-request
|========|------------->|============|----------->|========|
| client |              | web-server |            |   app  |
|========|<-------------|============|<-----------|========|
                                        response
```

> **Web-server** - программа которая принимает входящие http-запросы и передаёт их на обработку приложению.

> Приложение делает свою работу и отдаёт результат веб-серверу.  
> Веб-сервер формирует http-ответ и возвращает клиенту.

> **Proxy-server** - (или reverse server) работает между клиентом и внутренней инфраструктурой;  
> принимает запросы клиента и переадресует на внутренний сервер/сервера.

> Прокси-сервер нужен для более эффективной раздачи ресурсов (сжатие, кеширование), т.к. встроенные  
> веб-сервера (типа nodeJS) ограничены в возможностях.  
> Используют nginx, caddy.

___

> **Горизонтальное масштабирование** - несколько равноправных серверов с развёрнутым приложением;  
> для снижения нагрузки и повышения отказоустойчивости.

> Добавление серверов может быть автоматическое, в зависимости от нагрузки.

> **Балансировка** - распределение запросов между серверами.

> **DNS балансировка** - клиент (браузер) запрашивает ip-адрес домена, DNS возвращает список ip-адресов  
> в произвольном порядке, клиент обычно берёт первый адрес;  
> DNS не проверяет сервера на доступность.

> **Балансировщик нагрузки** - отдельный сервер (nginx); принимает все запросы и распределяет между доступными серверами;  
> может выбрать ближайший сервер, сокращая задержку;
> недостаток: отказ балансировщика руинит весь проект.

___

## Deploy process

1. приложение устанавливается на все сервера
2. останавливается старая версия приложения
3. накатываются миграции db (после остановки старой версии приложения, т.к. миграция может сломать логику)
4. запускается новая версия приложения

> Чтобы избежать ошибок при миграции, нужно соблюдать обратную совместимость (не удалять/переименовывать, а  
> расширять таблицы).

___

## Zero downtime deploy

1. скачиваем новую версию приложения на сервера
2. выполняем миграции
3. обновляем первый сервер:
   - выводим из-под балансировщика (чтобы он не отправлял на него запросы)
   - останавливаем текущую и запускаем новую версию приложения
   - добавляем сервер в балансировщик
4. повторяем то же с остальными серверами

___


